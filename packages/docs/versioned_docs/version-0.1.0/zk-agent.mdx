---
sidebar_position: 4
title: ZK Agent Integration
---

# ZK Agent Integration

This page documents the ZK agent flow for submitting proofs and receiving decisions without exposing raw scores.

## Endpoints

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/api/v1/policies` | Returns active policy hashes by context |
| `POST` | `/api/v1/agent/decide` | Verifies a proof and returns a decision |
| `POST` | `/api/v1/agent/submit` | Submits a verified decision on-chain via relayer |

## Getting Policy Hashes

Use the policy listing endpoint to retrieve the correct `policyHash` for your context:

```bash
curl https://basecred.com/api/v1/policies
```

**200 OK**

```json
{
  "policies": [
    {
      "context": "allowlist.general",
      "policyHash": "sha256:<hash>",
      "normalizationVersion": "v1"
    }
  ]
}
```

## Submit a Proof for Verification

<div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 mb-4">
  <span className="bg-purple-900/30 text-purple-400 border border-purple-900/50 text-xs font-bold px-2 py-0.5 rounded mr-2">
    POST
  </span>
  <code className="text-zinc-300">
    /api/v1/agent/decide
  </code>
</div>

Submits a ZK proof and policy hash for server-side verification. Returns a decision without exposing raw scores.

### Request body

| Field | Type | Required | Description |
|---|---|---|---|
| `subject` | `string` | No | Wallet address (optional, for logging) |
| `context` | `string` | Yes | Decision context |
| `proof` | `ProofPayload` | Yes | Proof object (see below) |
| `publicInputs` | `PublicInputs` | Yes | Public inputs for verification |

### Proof format (snarkjs)

Use this format when submitting a Groth16 proof generated by snarkjs:

```json
{
  "subject": "0xabc123...",
  "context": "allowlist.general",
  "proof": {
    "snarkjsProof": {
      "pi_a": ["1", "2"],
      "pi_b": [["1", "2"], ["3", "4"]],
      "pi_c": ["1", "2"],
      "protocol": "groth16"
    }
  },
  "publicInputs": {
    "policyHash": "sha256:<policy-hash>",
    "snarkjsPublicSignals": ["<policyHash>", "<contextId>", "<decision>"]
  }
}
```

**`proof` object** — must include one of:

| Field | Type | Description |
|---|---|---|
| `snarkjsProof` | `object` | Full snarkjs proof object (`pi_a`, `pi_b`, `pi_c`, `protocol`) |
| `proof` | `any` | Alternative proof format |

**`publicInputs` object** — must include `policyHash` and one of:

| Field | Type | Description |
|---|---|---|
| `policyHash` | `string` | Must match the active policy for the context |
| `snarkjsPublicSignals` | `string[]` | Public signals from snarkjs |
| `signals` | `Record<string, unknown>` | Alternative: plaintext signals (dev-only) |

### Dev-only plaintext signals

Requires `ZK_ALLOW_PLAINTEXT_SIGNALS=true` and `NODE_ENV != "production"`.

```json
{
  "context": "comment",
  "proof": { "proof": "dev" },
  "publicInputs": {
    "policyHash": "sha256:<policy-hash>",
    "signals": {
      "trust": "HIGH",
      "socialTrust": "HIGH",
      "builder": "EXPERT",
      "creator": "EXPERT",
      "recencyDays": 10,
      "spamRisk": "NEUTRAL",
      "signalCoverage": 1
    }
  }
}
```

### Response

Successful responses include the `x-policy-hash` header for auditing.

**Error responses**

| Status | Code | Description |
|---|---|---|
| 400 | `INVALID_REQUEST` | Missing fields or invalid proof format |
| 400 | `DECISION_ERROR` | Invalid proof or missing signals |
| 404 | `DECISION_ERROR` | Policy not found for context |
| 409 | `DECISION_ERROR` | Policy hash mismatch (stale policy) |
| 500 | `DECISION_ERROR` | Server error |

## Submit Decision On-Chain

<div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 mb-4">
  <span className="bg-emerald-900/30 text-emerald-400 border border-emerald-900/50 text-xs font-bold px-2 py-0.5 rounded mr-2">
    POST
  </span>
  <code className="text-zinc-300">
    /api/v1/agent/submit
  </code>
</div>

Submits a verified decision on-chain via the relayer wallet. The relayer pays gas and writes the decision to the `DecisionRegistry` contract on Base Sepolia.

### Request body

```json
{
  "subject": "0xabc123...",
  "context": "allowlist.general",
  "decision": "ALLOW",
  "policyHash": "sha256:<policy-hash>",
  "proof": {
    "a": ["0x...", "0x..."],
    "b": [["0x...", "0x..."], ["0x...", "0x..."]],
    "c": ["0x...", "0x..."]
  },
  "publicSignals": ["<policyHash>", "<contextId>", "<decision>"]
}
```

| Field | Type | Required | Description |
|---|---|---|---|
| `subject` | `string` | Yes | Wallet address |
| `context` | `string` | Yes | Decision context |
| `decision` | `"ALLOW" \| "DENY" \| "ALLOW_WITH_LIMITS"` | Yes | The decision to record |
| `policyHash` | `string` | Yes | Policy hash used for the decision |
| `proof` | `{ a, b, c }` | Yes | Groth16 proof in contract-ready format |
| `publicSignals` | `[string, string, string]` | Yes | `[policyHash, contextId, decision]` |

### Response

**200 OK**

```json
{
  "success": true,
  "transactionHash": "0x...",
  "subjectHash": "0x<bytes32>",
  "contextBytes32": "0x<bytes32>",
  "policyHashBytes32": "0x<bytes32>"
}
```

| Field | Type | Description |
|---|---|---|
| `success` | `boolean` | Whether the transaction was submitted |
| `transactionHash` | `string` | On-chain transaction hash |
| `subjectHash` | `string` | `bytes32` hash of the subject |
| `contextBytes32` | `string` | `bytes32` encoding of the context |
| `policyHashBytes32` | `string` | `bytes32` encoding of the policy hash |

**Error responses**

| Status | Code | Description |
|---|---|---|
| 400 | `INVALID_REQUEST` | Missing or invalid fields |
| 400 | `SUBMIT_ERROR` | Invalid proof or mismatch |
| 422 | `SUBMIT_ERROR` | Transaction reverted on-chain |
| 503 | `CONFIG_ERROR` | Relayer not configured |
| 500 | `SUBMIT_ERROR` | Server error |

## Typical Agent Flow

1. **Get policies** — `GET /api/v1/policies` to fetch the current `policyHash` for your context.
2. **Generate proof** — `POST /api/v1/decide-with-proof` to evaluate the subject and get a ZK proof.
3. **Verify proof** (optional) — `POST /api/v1/agent/decide` to verify the proof server-side.
4. **Submit on-chain** — `POST /api/v1/agent/submit` to write the decision to the `DecisionRegistry`.

## Notes

- The verifier expects Groth16 proofs in snarkjs format.
- Policy hashes are derived from the canonical policy definitions in the decision engine.
- The API will reject requests when the policy hash does not match the active policy for the requested context.
- Successful responses from `/agent/decide` include the `x-policy-hash` header for auditing.
- The `/agent/submit` endpoint requires a configured relayer wallet (`RELAYER_PRIVATE_KEY`). If the relayer is not configured, the endpoint returns `503`.
